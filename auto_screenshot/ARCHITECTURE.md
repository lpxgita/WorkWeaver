# 自动截图服务 - 架构设计文档

## 1. 项目概述

### 1.1 目标
创建一个**无界面的命令行截图服务**，通过配置文件控制截图行为，为后续 AI 总结功能提供截图数据支持。

### 1.2 核心需求
- 通过 YAML/JSON 配置文件定义截图参数
- 命令行启动，后台运行
- 支持秒级截图间隔（默认 5 秒）
- 支持多显示器截图
- 支持时间范围和工作日限制
- 支持图像尺寸和质量调整
- 支持优雅关闭（SIGINT/SIGTERM）

### 1.3 与原 Electron 应用的区别

| 特性 | Electron 应用 | 命令行服务 |
|------|---------------|------------|
| 界面 | GUI + 系统托盘 | 无界面 |
| 配置方式 | localStorage + IPC | 配置文件 |
| 启动方式 | 双击应用 | `node main.js` 或 `npm start` |
| 依赖 | Electron 全家桶 | 仅 Node.js 核心库 |
| 体积 | ~200MB | ~50MB |

---

## 2. 系统架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     命令行截图服务                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   配置模块   │    │   截图引擎   │    │   日志模块   │     │
│  │  (Config)   │───►│ (Screenshot)│───►│  (Logger)   │     │
│  └─────────────┘    └──────┬──────┘    └─────────────┘     │
│         │                  │                               │
│         │           ┌──────▼──────┐                        │
│         │           │  调度器      │                        │
│         └──────────►│ (Scheduler) │                        │
│                     └──────┬──────┘                        │
│                            │                               │
│                     ┌──────▼──────┐                        │
│                     │  文件存储    │                        │
│                     │  (Storage)  │                        │
│                     └─────────────┘                        │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  外部依赖: screenshot-desktop, sharp                         │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块职责

| 模块 | 文件 | 职责 |
|------|------|------|
| **配置模块** | `src/config.js` | 加载和验证配置文件 |
| **截图引擎** | `src/screenshot.js` | 执行截图、图像处理 |
| **调度器** | `src/scheduler.js` | 定时任务管理、条件判断 |
| **文件存储** | `src/storage.js` | 目录创建、文件命名、保存 |
| **日志模块** | `src/logger.js` | 控制台和文件日志 |
| **主入口** | `main.js` | 启动服务、信号处理 |

---

## 3. 目录结构

```
work_monitor/auto_screenshot/
├── main.js                 # 主入口
├── package.json            # 项目配置
├── config.example.yaml     # 配置文件示例
├── config.yaml             # 用户配置（gitignore）
├── src/
│   ├── config.js           # 配置加载模块
│   ├── screenshot.js       # 截图引擎
│   ├── scheduler.js        # 调度器
│   ├── storage.js          # 文件存储
│   └── logger.js           # 日志模块
├── logs/                   # 日志目录
└── screenshots/            # 默认截图保存目录
```

---

## 4. 配置文件设计

### 4.1 配置文件格式 (YAML)

```yaml
# config.yaml - 自动截图服务配置

# 截图设置
screenshot:
  interval: 5                    # 截图间隔（秒）
  format: "jpeg"                 # 图片格式: jpeg | png
  quality: 80                    # JPEG 质量 (1-100)
  dimension: 100                 # 尺寸百分比 (25/50/75/100)
  monitors: "all"                # 显示器: all | [0, 1] (指定索引)

# 存储设置
storage:
  directory: "./screenshots"     # 保存目录（相对或绝对路径）
  naming:
    pattern: "{date}_{time}_{monitor}"  # 文件命名模式
    date_format: "YYYY-MM-DD"    # 日期格式
    time_format: "HH-mm-ss"      # 时间格式
  organize_by_date: true         # 是否按日期创建子目录

# 时间限制
schedule:
  enabled: true                  # 是否启用时间限制
  start_time: "08:00"            # 开始时间
  end_time: "22:00"              # 结束时间
  days:                          # 允许的工作日
    - Mon
    - Tue
    - Wed
    - Thu
    - Fri

# 日志设置
logging:
  level: "info"                  # 日志级别: debug | info | warn | error
  file: "./logs/screenshot.log"  # 日志文件路径
  console: true                  # 是否输出到控制台
```

### 4.2 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `screenshot.interval` | number | 5 | 截图间隔（秒），最小 1 秒 |
| `screenshot.format` | string | "jpeg" | 图片格式 |
| `screenshot.quality` | number | 80 | JPEG 质量 |
| `screenshot.dimension` | number | 100 | 尺寸百分比 |
| `storage.directory` | string | "./screenshots" | 保存目录 |
| `storage.organize_by_date` | boolean | true | 按日期分目录 |
| `schedule.enabled` | boolean | true | 时间限制开关 |
| `schedule.start_time` | string | "08:00" | 开始时间 |
| `schedule.end_time` | string | "22:00" | 结束时间 |
| `schedule.days` | array | Mon-Fri | 允许的工作日 |

---

## 5. 核心流程

### 5.1 启动流程

```
命令行启动 (node main.js [--config path])
    │
    ▼
┌─────────────────┐
│ 1. 加载配置文件  │
│    - 解析 YAML   │
│    - 验证参数    │
│    - 应用默认值  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. 初始化模块   │
│    - Logger     │
│    - Storage    │
│    - Screenshot │
│    - Scheduler  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 注册信号处理 │
│    - SIGINT     │
│    - SIGTERM    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. 启动调度器   │
│    - 立即截图   │
│    - 启动定时器 │
└────────┬────────┘
         │
         ▼
    [服务运行中]
```

### 5.2 截图流程

```
定时器触发
    │
    ▼
┌─────────────────┐
│ 1. 条件检查     │  ──► 不满足 ──► 跳过本次
│    - 工作日     │
│    - 时间范围   │
└────────┬────────┘
         │ 满足
         ▼
┌─────────────────┐
│ 2. 获取显示器   │
│    列表         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 遍历截图     │
│    - 截取屏幕   │
│    - 调整尺寸   │
│    - 保存文件   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. 记录日志     │
└─────────────────┘
```

### 5.3 优雅关闭流程

```
收到 SIGINT/SIGTERM
    │
    ▼
┌─────────────────┐
│ 1. 停止定时器   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. 等待当前截图 │
│    完成         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 关闭日志流   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. 退出进程     │
│    exit(0)      │
└─────────────────┘
```

---

## 6. 命令行接口

### 6.1 启动命令

```bash
# 使用默认配置文件 (config.yaml)
node main.js

# 指定配置文件
node main.js --config /path/to/config.yaml

# 使用 npm
npm start
npm start -- --config /path/to/config.yaml
```

### 6.2 命令行参数

| 参数 | 简写 | 说明 |
|------|------|------|
| `--config` | `-c` | 指定配置文件路径 |
| `--help` | `-h` | 显示帮助信息 |
| `--version` | `-v` | 显示版本号 |

### 6.3 运行示例

```bash
$ node main.js --config ./config.yaml

[2026-02-05 14:30:00] [INFO] 自动截图服务启动
[2026-02-05 14:30:00] [INFO] 配置加载完成: 间隔=5秒, 目录=./screenshots
[2026-02-05 14:30:00] [INFO] 截图保存: 2026-02-05/2026-02-05_14-30-00_1.jpeg
[2026-02-05 14:30:05] [INFO] 截图保存: 2026-02-05/2026-02-05_14-30-05_1.jpeg
...
^C
[2026-02-05 14:35:00] [INFO] 收到停止信号，正在关闭...
[2026-02-05 14:35:00] [INFO] 服务已停止
```

---

## 7. 依赖清单

### 7.1 生产依赖

| 包名 | 版本 | 用途 |
|------|------|------|
| `screenshot-desktop` | ^1.14.0 | 跨平台截图 |
| `sharp` | ^0.34.0 | 图像处理（调整尺寸） |
| `yaml` | ^2.3.0 | YAML 配置解析 |

### 7.2 开发依赖

| 包名 | 版本 | 用途 |
|------|------|------|
| (无) | - | 保持轻量 |

### 7.3 与 Electron 版本对比

| 依赖 | Electron 版本 | CLI 版本 |
|------|---------------|----------|
| electron | 25.3.0 | ❌ 移除 |
| electron-builder | 26.0.12 | ❌ 移除 |
| electron-store | 10.0.1 | ❌ 移除 |
| electron-updater | 6.6.2 | ❌ 移除 |
| bootstrap | 5.3.5 | ❌ 移除 |
| screenshot-desktop | 1.14.0 | ✅ 保留 |
| sharp | 0.34.0 | ✅ 保留 |
| yaml | - | ✅ 新增 |

---

## 8. 后续扩展点

### 8.1 与 AI 总结模块集成

```
auto_screenshot/          work_monitor/
     │                         │
     │ 截图文件                 │
     └────────►  ai_summarizer/ │
                     │         │
                     │ 读取截图 │
                     ▼         │
              ┌─────────────┐  │
              │  AI 总结    │  │
              │  - 每分钟   │  │
              │  - 上下文   │  │
              └─────────────┘  │
```

### 8.2 可选功能（未来）

- [ ] 热重载配置文件
- [ ] HTTP API 接口（启动/停止/状态查询）
- [ ] 截图事件回调（用于触发 AI 总结）
- [ ] 系统锁屏检测（需要额外依赖）
- [ ] 截图去重（相似度检测）
