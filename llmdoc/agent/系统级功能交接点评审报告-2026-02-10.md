# 系统级功能交接点评审报告（2026-02-10）

## 1. 评审目标
- 从整体视角检查 `auto_screenshot`、`ai_summary`、`electron-app`、`active_window` 的功能交接方式。
- 核对 Prompt 制作阶段是否注入“焦点窗口变化时间线”，并确认实际格式。
- 识别跨模块交接中的潜在失配点，提出可执行的架构改进方案。

## 2. 关键核对结论

### 2.1 Prompt 阶段是否会合成焦点窗口时间线
- 会。`ai_summary/src/summary-scheduler.js` 在 `SummaryScheduler._run2min`、`SummaryScheduler._run10min`、`SummaryScheduler._run1h` 中调用 `ActiveWindowCollector.getTimelineInRange` 与 `ActiveWindowCollector.formatForPrompt`，并将结果传入 `PromptBuilder`。
- 注入位置在 `ai_summary/src/prompt-builder.js` 的 `PromptBuilder.build2min`、`PromptBuilder.build10min`、`PromptBuilder.build1h`。

### 2.2 是否是 `"cursor" 10:02:56-10:03:17` 这种格式
- 结论：属于“可能出现的一种子集格式”，但不是完整唯一格式。
- 当前实现实际会输出两类：
  - `"Cursor" 10:02:56-10:03:17`（窗口标题为空或与应用名一致）
  - `"Cursor - work_monitor" 10:02:56-10:03:17`（应用名与窗口标题拼接）
- 生成逻辑见 `ai_summary/src/active-window-collector.js` 的 `ActiveWindowCollector.formatForPrompt`、`ActiveWindowCollector._buildFullWindowName`、`ActiveWindowCollector._formatTimestamp`。
- 当前文案与实现存在轻微偏差：部分文档/Prompt 描述为“完整焦点窗口名(应用名-窗口标题)”，但实现为“应用名 - 窗口标题”（无括号）。

## 3. 全局交接点矩阵（模块到模块）

| 上游 | 下游 | 交接媒介 | 核心契约 | 关键实现位置 |
|---|---|---|---|---|
| `auto_screenshot` | `ai_summary` | 文件系统 | 截图目录、文件命名、时间解析规则 | `auto_screenshot/src/storage.js`、`ai_summary/src/screenshot-reader.js` |
| `ai_summary`(2min) | `ai_summary`(10min) | 文件系统 JSON | 2min 字段语义与时间戳一致性 | `ai_summary/src/summary-store.js`、`ai_summary/src/summary-scheduler.js` |
| `ai_summary`(10min) | `ai_summary`(1h) | 文件系统 JSON | `activity_timeline` 与聚合口径 | `ai_summary/src/prompt-builder.js`、`ai_summary/src/summary-scheduler.js` |
| `active_window` 采集链路 | `ai_summary` Prompt | 内存时间线 + 文本注入 | 窗口名称格式、时间范围切片 | `ai_summary/src/active-window-collector.js`、`ai_summary/src/prompt-builder.js` |
| `electron-app` | `auto_screenshot` / `ai_summary` | 子进程参数 | `--config`、`--todo-dir`、工作目录/路径解析 | `electron-app/service-manager.js` |
| `ai_summary` | `electron-app` | 文件系统 + IPC 查询 | 总结目录结构、token 统计格式、粒度约定 | `ai_summary/src/summary-store.js`、`ai_summary/src/token-tracker.js`、`electron-app/summary-reader.js` |
| `electron-app` Todo | `ai_summary` 分类与回写 | JSON 文件 | 任务/行为命名一致性、重命名回写一致性 | `electron-app/todo-store.js`、`ai_summary/src/prompt-builder.js`、`ai_summary/src/todo-writer.js` |

## 4. 已识别的失配风险（跨功能交接点）
- Prompt 文案与焦点窗口实际格式不完全一致，可能引入模型解析偏差。
- `ai_summary/src/screenshot-reader.js` 对截图命名解析存在硬编码正则，若 `storage.naming.pattern` 变化，读取可能失效。
- 相对路径基准存在多处实现，`ai_summary` 与 `electron-app` 的路径解析口径可能不一致。
- 历史 `1min` 与当前 `2min` 粒度共存，查询与展示可能出现口径混用。
- 文件名时间（`HH-mm` / `HH-mm-ss`）与 JSON `timestamp`（ISO）并存，缺少统一“主时间语义”说明。
- 总结 JSON 缺少显式 schema/version 字段，后续字段演进时兼容成本会上升。
- 子进程日志当前以文本行为主，缺少结构化事件和统一 `trace_id`，交接异常定位成本高。
- Todo 重命名/合并会回写历史总结，缺少“变更审计元数据”时，追溯历史口径变更较困难。

## 5. 更优设计思路（从总体视角监视交接点）

### P0（优先落地）
- 统一焦点窗口输出契约：将 `PromptBuilder` 文案、`ActiveWindowCollector` 注释、相关 llmdoc 统一为同一格式描述。
- 建立“交接契约文档”单一真源：新增 `llmdoc/reference/data-contracts.md`，明确目录结构、命名规则、时间字段语义、粒度约束、版本策略。
- 增加启动前交接健康检查：在服务启动时验证截图目录可读写、命名可解析、总结目录可落盘、Todo 目录可访问。

### P1（增强稳定性）
- 抽离共享路径解析模块：统一 `~` 展开、相对路径基准、开发/打包环境路径策略，避免多处复制逻辑。
- 为关键交接对象引入 schema 版本：截图元数据、2min/10min/1h 总结、token 统计分别增加 `schema_version`。
- 将核心日志结构化：至少覆盖 `module`、`event`、`timestamp`、`trace_id`、`status`、`error_code`。

### P2（提升可观测与可演进）
- 建立“交接点监视面板”：按分钟统计截图采集成功率、总结生成成功率、no_change 比例、窗口时间线覆盖率、Todo 回写成功率。
- 增加契约测试套件：围绕 `storage -> reader -> summary-store -> summary-reader` 建立回归用例，覆盖命名变化、时区、跨天、空目录、损坏文件。
- 为跨模块事件补充链路 ID：将一次 2min 周期内的截图读取、prompt 组装、模型调用、落盘写入串成可追踪链路。

## 6. 建议的交接点监视指标（可直接实施）
- `screenshot_ingest_success_rate`：截图文件发现并成功解析的比例。
- `screenshot_parse_error_count`：命名/时间解析失败次数。
- `summary_write_success_rate`：各粒度总结落盘成功率。
- `summary_lag_seconds`：截图时间到总结落盘的延迟。
- `active_window_coverage_ratio`：窗口时间线覆盖目标时间窗的比例。
- `no_change_ratio_by_granularity`：2min/10min/1h 的无变化占比。
- `todo_writeback_success_rate`：任务/行为回写成功率。
- `cross_module_trace_completeness`：有完整链路 ID 的周期占比。

## 7. 结论
- 当前架构已形成可运行的分层流水线，功能交接点总体清晰。
- 主要问题不在“功能缺失”，而在“交接契约与观测一致性”：格式、路径、粒度与日志链路尚未完全标准化。
- 先做 P0 契约统一和健康检查，可在不重构主流程的前提下，明显降低跨模块失配风险。
